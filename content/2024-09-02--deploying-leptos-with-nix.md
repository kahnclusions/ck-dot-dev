---
title: Deploy your Rust app with Nix
date: 2024-09-02
description: Deploying your Rust (Leptos) app to NixOS
published: true
---

Once you've got your Leptos app compiling and running as a Nix flake, the next thing you'll want to do is deploy it to a NixOS VM so you can serve it.

### Step 1. Add your app as a flake input to your Nix config

```nix
{
  inputs = {
    nixpkgs.url = "nixpkgs/nixos-23.11";
    nixpkgs-unstable.url = "nixpkgs/nixos-unstable";
    sops-nix.url = "github:Mic92/sops-nix";
    nixos-hardware.url = "github:nixos/nixos-hardware";
    myapp.url = "github:myorg/myapp"; # <-- like this one if your repo is public
    myapp.url = "git+ssh://git@github.com/myorg/myapp.git"; # <-- or like this if your repo is private, but you need to make sure you have an authorized SSH key when building.
  };

  outputs = { self, nixpkgs, nixpkgs-unstable, nixos-hardware, sops-nix, myapp } @ inputs: {
    nixosConfigurations = {
      "myserver" = nixpkgs.lib.nixosSystem {
        system = "x86_64-linux";
        specialArgs = {
          inherit inputs; # so we can refer to inputs from our machine config
        };
        modules = [
          # your modules here, for brevity I've only included this one:
          ./machines/myserver.nix
        ];
      }; 
    };
  };
}
```

### Step 2. Add a systemd configuration for your app

Here we just add the new service definition, and point it to the executable that's generated by our app's flake outputs. If you have multiple output packages you would reference that below instead of `.default`. We also add environment varialbes, such as the location of the leptos site root.

```nix
{ config, pkgs, inputs, ... }:
{
  # ... 

  systemd.services.myapp = {
      enable = true;
      description = "myapp";
      unitConfig = {
        Type = "simple";
      };
      environment = {
        LEPTOS_SITE_ROOT = "${inputs.myapp.packages.${pkgs.system}.default}/bin/site";
        LEPTOS_SITE_ADDR = "127.0.0.1:3333";
        LEPTOS_ENV = "PROD";
        LEPTOS_HASH_FILES = "true";
        # add extra environment variables here
      };
      serviceConfig = {
        Restart="always";
        ExecStart = "${inputs.myapp.packages.${pkgs.system}.default}/bin/myapp-server";
        WorkingDirectory = "${inputs.myapp.packages.${pkgs.system}.default}/bin";
      };
      wantedBy = [ "multi-user.target" ];
  };
};
```

That's it!

Rebuild your NixOS configuration and your service should be up and running:

```
sudo nixos-rebuild switch
sudo systemctl status myapp
```

Later I'll show up to use Age/SOPS to add some secrets.
